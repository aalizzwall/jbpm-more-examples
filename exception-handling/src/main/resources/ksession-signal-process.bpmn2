<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.omg.org/bpmn20"
  xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:drools="http://www.jboss.org/drools" id="_2rZToJFBEeKO6dhLFDgkzg"
  xsi:schemaLocation="http://www.omg.org/spec/BPMN/20100524/MODEL BPMN20.xsd" targetNamespace="http://www.omg.org/bpmn20">

  <bpmn2:itemDefinition id="service-task_InMessageType" />

  <bpmn2:message id="service-task_InMessage" itemRef="service-task_InMessageType" />
  <bpmn2:interface id="service-task_ServiceInterface" name="com.test.ExceptionHandler">
    <bpmn2:operation id="service-task_ServiceOperation" name="execute">
      <bpmn2:inMessageRef>service-task_InMessage</bpmn2:inMessageRef>
    </bpmn2:operation>
  </bpmn2:interface>

  <bpmn2:itemDefinition id="_ksessionItem" structureRef="org.drools.runtime.StatefulKnowledgeSession" />

  <bpmn2:itemDefinition id="_exceptionItem" structureRef="org.drools.runtime.process.WorkItem" />
  <bpmn2:signal id="exception-signal" structureRef="_exceptionItem" />

  <bpmn2:message id="_exceptionMessage" itemRef="_exceptionItem" />
  <bpmn2:interface id="_handlingServiceInterface" name="com.test.ExceptionService">
    <bpmn2:operation id="_handlingServiceOperation" name="handleException">
      <bpmn2:inMessageRef>_exceptionMessage</bpmn2:inMessageRef>
    </bpmn2:operation>
  </bpmn2:interface>

  <bpmn2:process id="ErrorHandler" name="Example process for error handling" isExecutable="true">

    <bpmn2:property id="ksession" itemSubjectRef="_ksessionItem"/>

    <bpmn2:startEvent id="start-event" />
    <bpmn2:sequenceFlow id="seq-1" sourceRef="start-event" targetRef="service-task" />

    <bpmn2:serviceTask id="service-task" 
        drools:servicetaskinterface="com.test.MyService"
        drools:servicetaskoperation="execute" 
        name="ServiceRaiseException" 
        implementation="Other" 
        operationRef="service-task_ServiceOperation" />
    <bpmn2:sequenceFlow id="seq-2" sourceRef="service-task" targetRef="end-event" />

    <bpmn2:endEvent id="end-event" />

    <bpmn2:boundaryEvent id="bnd-event" name="exception" attachedToRef="service-task" cancelActivity="false">
      <bpmn2:dataOutput id="bnd-event_ErrorMessage" name="ErrorMessage" />
      <bpmn2:outputSet id="bnd-event-output">
        <bpmn2:dataOutputRefs>bnd-event_ErrorMessage</bpmn2:dataOutputRefs>
      </bpmn2:outputSet>
      <bpmn2:signalEventDefinition id="signal-error-event" signalRef="exception-signal"/>
    </bpmn2:boundaryEvent>
    <bpmn2:sequenceFlow id="seq-3" sourceRef="bnd-event" targetRef="handle-exception" />

    <bpmn2:serviceTask id="handle-exception" name="Handle Exception" implementation="Other" operationRef="_handlingServiceOperation">
      <bpmn2:ioSpecification>
        <bpmn2:dataInput id="_h-e_input" name="Parameter" />
        <bpmn2:inputSet>
          <bpmn2:dataInputRefs>_h-e_input</bpmn2:dataInputRefs>
        </bpmn2:inputSet>
        <bpmn2:outputSet />
      </bpmn2:ioSpecification>
      <bpmn2:dataInputAssociation>
        <bpmn2:sourceRef>exceptionInputItem</bpmn2:sourceRef>
        <bpmn2:targetRef>_h-e_input</bpmn2:targetRef>
      </bpmn2:dataInputAssociation>
    </bpmn2:serviceTask>
    
    <bpmn2:endEvent id="end-event" />
  </bpmn2:process>

</bpmn2:definitions>
